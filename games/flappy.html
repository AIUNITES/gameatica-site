<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Flappy - Gameatica</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/games.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üê¶</text></svg>">
    <style>
        .flappy-container {
            position: relative;
            display: flex;
            justify-content: center;
        }
        #gameCanvas {
            border-radius: 12px;
            cursor: pointer;
        }
        .tap-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: none;
            opacity: 0.8;
        }
        .tap-hint h2 { font-size: 1.5rem; margin-bottom: 10px; }
        .tap-hint p { color: var(--gray-light); }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <a href="../index.html" class="back-btn">‚Üê Back to Arcade</a>
            <h1>üê¶ Flappy</h1>
        </div>
        
        <div class="score-bar">
            <div class="score-item">
                <div class="label">Score</div>
                <div class="value" id="score">0</div>
            </div>
            <div class="score-item">
                <div class="label">Best</div>
                <div class="value" id="best">0</div>
            </div>
        </div>

        <div class="game-board">
            <div class="flappy-container">
                <canvas id="gameCanvas" width="320" height="480"></canvas>
                <div class="tap-hint" id="tapHint">
                    <h2>üê¶ Flappy</h2>
                    <p>Tap or press Space to fly!</p>
                </div>
            </div>
        </div>

        <div class="game-controls">
            <button class="btn btn-primary" id="startBtn">‚ñ∂ Start Game</button>
        </div>

        <div class="leaderboard">
            <h3>üèÜ High Scores</h3>
            <div id="leaderboard"></div>
        </div>

        <div class="instructions">
            <h3>How to Play</h3>
            <ul>
                <li>Tap, click, or press Space to flap</li>
                <li>Navigate through the pipes</li>
                <li>Don't hit the pipes or ground!</li>
                <li>Each pipe passed = 1 point</li>
            </ul>
        </div>
    </div>

    <script src="../js/cloud-database.js"></script>
    <script src="../js/game-utils.js"></script>
    <script>
        const GAME_ID = 'flappy';
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const GRAVITY = 0.5;
        const FLAP_POWER = -8;
        const PIPE_WIDTH = 52;
        const PIPE_GAP = 140;
        const PIPE_SPEED = 3;
        
        const COLORS = {
            sky: '#70c5ce',
            ground: '#ded895',
            pipe: '#73bf2e',
            pipeDark: '#558022',
            bird: '#f9c74f'
        };
        
        let bird = { x: 80, y: 200, velocity: 0, size: 24 };
        let pipes = [];
        let score = 0;
        let isRunning = false;
        let gameOver = false;
        let animationId = null;
        let frameCount = 0;
        
        function init() {
            bird = { x: 80, y: 200, velocity: 0, size: 24 };
            pipes = [];
            score = 0;
            gameOver = false;
            frameCount = 0;
            
            draw();
            updateUI();
            
            document.getElementById('best').textContent = GameUtils.getPersonalBest(GAME_ID);
            document.getElementById('tapHint').style.display = 'block';
            GameUtils.renderLeaderboard(GAME_ID, 'leaderboard');
        }
        
        function draw() {
            // Sky
            ctx.fillStyle = COLORS.sky;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Pipes
            pipes.forEach(pipe => {
                // Top pipe
                ctx.fillStyle = COLORS.pipe;
                ctx.fillRect(pipe.x, 0, PIPE_WIDTH, pipe.top);
                ctx.fillStyle = COLORS.pipeDark;
                ctx.fillRect(pipe.x, pipe.top - 20, PIPE_WIDTH, 20);
                
                // Bottom pipe
                ctx.fillStyle = COLORS.pipe;
                ctx.fillRect(pipe.x, pipe.bottom, PIPE_WIDTH, canvas.height - pipe.bottom - 60);
                ctx.fillStyle = COLORS.pipeDark;
                ctx.fillRect(pipe.x, pipe.bottom, PIPE_WIDTH, 20);
            });
            
            // Ground
            ctx.fillStyle = COLORS.ground;
            ctx.fillRect(0, canvas.height - 60, canvas.width, 60);
            ctx.fillStyle = '#8b7355';
            ctx.fillRect(0, canvas.height - 60, canvas.width, 4);
            
            // Bird
            ctx.save();
            ctx.translate(bird.x, bird.y);
            ctx.rotate(Math.min(bird.velocity * 0.05, 0.5));
            
            // Body
            ctx.fillStyle = COLORS.bird;
            ctx.beginPath();
            ctx.ellipse(0, 0, bird.size, bird.size * 0.8, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Wing
            ctx.fillStyle = '#e8a838';
            ctx.beginPath();
            ctx.ellipse(-5, 5, 10, 6, -0.3, 0, Math.PI * 2);
            ctx.fill();
            
            // Eye
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(8, -5, 8, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(10, -5, 4, 0, Math.PI * 2);
            ctx.fill();
            
            // Beak
            ctx.fillStyle = '#e85d04';
            ctx.beginPath();
            ctx.moveTo(15, 0);
            ctx.lineTo(25, 3);
            ctx.lineTo(15, 6);
            ctx.closePath();
            ctx.fill();
            
            ctx.restore();
            
            // Score
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 32px Inter';
            ctx.textAlign = 'center';
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 3;
            ctx.strokeText(score, canvas.width / 2, 50);
            ctx.fillText(score, canvas.width / 2, 50);
        }
        
        function update() {
            if (!isRunning || gameOver) return;
            
            frameCount++;
            
            // Bird physics
            bird.velocity += GRAVITY;
            bird.y += bird.velocity;
            
            // Generate pipes
            if (frameCount % 90 === 0) {
                const minTop = 50;
                const maxTop = canvas.height - PIPE_GAP - 110;
                const top = Math.random() * (maxTop - minTop) + minTop;
                
                pipes.push({
                    x: canvas.width,
                    top: top,
                    bottom: top + PIPE_GAP,
                    passed: false
                });
            }
            
            // Move pipes
            pipes.forEach(pipe => {
                pipe.x -= PIPE_SPEED;
                
                // Score
                if (!pipe.passed && pipe.x + PIPE_WIDTH < bird.x) {
                    pipe.passed = true;
                    score++;
                    GameUtils.playSound('point');
                    updateUI();
                }
            });
            
            // Remove off-screen pipes
            pipes = pipes.filter(pipe => pipe.x > -PIPE_WIDTH);
            
            // Collision detection
            const hitGround = bird.y + bird.size > canvas.height - 60;
            const hitCeiling = bird.y - bird.size < 0;
            
            let hitPipe = false;
            pipes.forEach(pipe => {
                if (bird.x + bird.size > pipe.x && bird.x - bird.size < pipe.x + PIPE_WIDTH) {
                    if (bird.y - bird.size < pipe.top || bird.y + bird.size > pipe.bottom) {
                        hitPipe = true;
                    }
                }
            });
            
            if (hitGround || hitCeiling || hitPipe) {
                endGame();
                return;
            }
            
            draw();
            animationId = requestAnimationFrame(update);
        }
        
        function flap() {
            if (gameOver) return;
            
            if (!isRunning) {
                isRunning = true;
                document.getElementById('tapHint').style.display = 'none';
                document.getElementById('startBtn').textContent = 'üîÑ Restart';
                update();
            }
            
            bird.velocity = FLAP_POWER;
            GameUtils.vibrate(20);
        }
        
        function endGame() {
            gameOver = true;
            isRunning = false;
            cancelAnimationFrame(animationId);
            
            GameUtils.playSound('gameover');
            GameUtils.vibrate([100, 50, 100]);
            GameUtils.showGameOver(score, GAME_ID);
        }
        
        function updateUI() {
            document.getElementById('score').textContent = score;
        }
        
        // Controls
        canvas.addEventListener('click', flap);
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            flap();
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                flap();
            }
        });
        
        document.getElementById('startBtn').addEventListener('click', () => {
            if (gameOver || !isRunning) {
                init();
            }
            flap();
        });
        
        init();
    </script>
</body>
</html>
