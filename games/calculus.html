<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Calculus Challenge - Gameatica</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/games.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚à´</text></svg>">
    <style>
        .problem-display {
            text-align: center;
            padding: 30px 20px;
        }
        .problem-type {
            font-size: 0.9rem;
            color: var(--primary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .equation {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 20px;
            font-family: 'Times New Roman', serif;
            color: var(--white);
            line-height: 1.4;
        }
        .equation sup { font-size: 0.7em; vertical-align: super; }
        .answer-choices {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            max-width: 500px;
            margin: 20px auto;
        }
        .choice-btn {
            padding: 15px 20px;
            background: var(--dark);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: var(--white);
            font-size: 1.1rem;
            font-family: 'Times New Roman', serif;
            cursor: pointer;
            transition: all 0.2s;
        }
        .choice-btn:hover {
            border-color: var(--primary);
            background: rgba(239, 68, 68, 0.1);
        }
        .choice-btn.correct {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.2);
        }
        .choice-btn.wrong {
            border-color: var(--primary);
            background: rgba(239, 68, 68, 0.2);
        }
        .choice-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .feedback {
            margin-top: 20px;
            font-size: 1.1rem;
            min-height: 30px;
        }
        .feedback.correct { color: var(--success); }
        .feedback.wrong { color: var(--primary); }
        .topic-tabs {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .topic-btn {
            padding: 8px 16px;
            background: var(--dark-card);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            color: var(--gray-light);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
        }
        .topic-btn:hover { border-color: var(--primary); color: var(--white); }
        .topic-btn.active {
            background: var(--gradient);
            border-color: transparent;
            color: var(--white);
        }
        .progress-bar {
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: var(--gradient);
            transition: width 0.3s;
        }
        .explanation {
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            color: var(--gray-light);
            font-size: 0.9rem;
            text-align: left;
            display: none;
        }
        .explanation.visible { display: block; }
        @media (max-width: 500px) {
            .answer-choices { grid-template-columns: 1fr; }
            .equation { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <a href="../index.html" class="back-btn">‚Üê Back to Arcade</a>
            <h1>‚à´ Calculus Challenge</h1>
        </div>
        
        <div class="score-bar">
            <div class="score-item">
                <div class="label">Score</div>
                <div class="value" id="score">0</div>
            </div>
            <div class="score-item">
                <div class="label">Correct</div>
                <div class="value" id="correct">0</div>
            </div>
            <div class="score-item">
                <div class="label">Streak</div>
                <div class="value" id="streak">0</div>
            </div>
            <div class="score-item">
                <div class="label">Best</div>
                <div class="value" id="best">0</div>
            </div>
        </div>

        <div class="topic-tabs">
            <button class="topic-btn active" data-topic="derivatives">Derivatives</button>
            <button class="topic-btn" data-topic="integrals">Integrals</button>
            <button class="topic-btn" data-topic="limits">Limits</button>
            <button class="topic-btn" data-topic="mixed">Mixed</button>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>

        <div class="game-board">
            <div class="problem-display">
                <div class="problem-type" id="problemType">DERIVATIVE</div>
                <div class="equation" id="equation">Find d/dx [x¬≤]</div>
                <div class="answer-choices" id="choices"></div>
                <div class="feedback" id="feedback"></div>
                <div class="explanation" id="explanation"></div>
            </div>
        </div>

        <div class="game-controls">
            <button class="btn btn-secondary" id="explainBtn" style="display:none">üìö Show Explanation</button>
            <button class="btn btn-primary" id="nextBtn" style="display:none">Next Problem ‚Üí</button>
        </div>

        <div class="leaderboard">
            <h3>üèÜ High Scores</h3>
            <div id="leaderboard"></div>
        </div>

        <div class="instructions">
            <h3>Topics Covered</h3>
            <ul>
                <li><strong>Derivatives:</strong> Power rule, chain rule, product rule, trig derivatives</li>
                <li><strong>Integrals:</strong> Basic antiderivatives, u-substitution</li>
                <li><strong>Limits:</strong> Basic limits, indeterminate forms</li>
            </ul>
        </div>
    </div>

    <script src="../js/cloud-database.js"></script>
    <script src="../js/game-utils.js"></script>
    <script>
        const GAME_ID = 'calculus';
        
        let score = 0;
        let correct = 0;
        let streak = 0;
        let maxStreak = 0;
        let problemNum = 0;
        let totalProblems = 10;
        let topic = 'derivatives';
        let currentProblem = null;
        let answered = false;
        
        const PROBLEMS = {
            derivatives: [
                { q: 'd/dx [x¬≤]', a: '2x', wrong: ['x', '2x¬≤', 'x¬≤'], explain: 'Power rule: d/dx[x‚Åø] = nx‚Åø‚Åª¬π' },
                { q: 'd/dx [x¬≥]', a: '3x¬≤', wrong: ['x¬≤', '3x', '3x¬≥'], explain: 'Power rule: bring down the 3, reduce exponent by 1' },
                { q: 'd/dx [5x]', a: '5', wrong: ['5x', 'x', '0'], explain: 'Derivative of ax = a (constant coefficient)' },
                { q: 'd/dx [x‚Å¥]', a: '4x¬≥', wrong: ['x¬≥', '4x', '4x‚Å¥'], explain: 'Power rule: 4¬∑x‚Å¥‚Åª¬π = 4x¬≥' },
                { q: 'd/dx [sin(x)]', a: 'cos(x)', wrong: ['-cos(x)', 'sin(x)', '-sin(x)'], explain: 'Basic trig derivative' },
                { q: 'd/dx [cos(x)]', a: '-sin(x)', wrong: ['sin(x)', 'cos(x)', '-cos(x)'], explain: 'Derivative of cos(x) = -sin(x)' },
                { q: 'd/dx [eÀ£]', a: 'eÀ£', wrong: ['xeÀ£‚Åª¬π', 'e', '1'], explain: 'eÀ£ is its own derivative!' },
                { q: 'd/dx [ln(x)]', a: '1/x', wrong: ['x', 'ln(x)', '1/ln(x)'], explain: 'Derivative of natural log' },
                { q: 'd/dx [x¬≤ + 3x]', a: '2x + 3', wrong: ['x¬≤ + 3', '2x', '2x + 3x'], explain: 'Sum rule: differentiate each term' },
                { q: 'd/dx [‚àöx]', a: '1/(2‚àöx)', wrong: ['‚àöx', '2‚àöx', '1/‚àöx'], explain: '‚àöx = x^(1/2), so derivative is (1/2)x^(-1/2)' },
                { q: 'd/dx [1/x]', a: '-1/x¬≤', wrong: ['1/x¬≤', '-1/x', '1'], explain: '1/x = x‚Åª¬π, derivative is -1¬∑x‚Åª¬≤ = -1/x¬≤' },
                { q: 'd/dx [x¬≤ ¬∑ x¬≥]', a: '5x‚Å¥', wrong: ['6x‚Åµ', '2x ¬∑ 3x¬≤', 'x‚Åµ'], explain: 'x¬≤¬∑x¬≥ = x‚Åµ, then power rule: 5x‚Å¥' },
                { q: 'd/dx [tan(x)]', a: 'sec¬≤(x)', wrong: ['cot(x)', '1/cos¬≤(x)', 'sin(x)/cos(x)'], explain: 'Derivative of tan(x) = sec¬≤(x)' },
                { q: 'd/dx [3x¬≤ - 2x + 1]', a: '6x - 2', wrong: ['6x - 2 + 1', '3x - 2', '6x¬≤ - 2'], explain: 'Differentiate term by term' },
            ],
            integrals: [
                { q: '‚à´ 2x dx', a: 'x¬≤ + C', wrong: ['2x¬≤', 'x¬≤', '2x¬≤ + C'], explain: 'Reverse power rule: increase exponent, divide by new exponent' },
                { q: '‚à´ x¬≤ dx', a: 'x¬≥/3 + C', wrong: ['x¬≥ + C', '2x + C', '3x¬≤ + C'], explain: '‚à´x‚Åødx = x‚Åø‚Å∫¬π/(n+1) + C' },
                { q: '‚à´ 1 dx', a: 'x + C', wrong: ['0', '1 + C', 'C'], explain: 'Integral of a constant k is kx + C' },
                { q: '‚à´ cos(x) dx', a: 'sin(x) + C', wrong: ['-sin(x) + C', 'cos(x) + C', 'tan(x) + C'], explain: 'Antiderivative of cos is sin' },
                { q: '‚à´ sin(x) dx', a: '-cos(x) + C', wrong: ['cos(x) + C', '-sin(x) + C', 'sin(x) + C'], explain: 'Antiderivative of sin is -cos' },
                { q: '‚à´ eÀ£ dx', a: 'eÀ£ + C', wrong: ['xeÀ£ + C', 'eÀ£', 'eÀ£‚Å∫¬π + C'], explain: 'eÀ£ integrates to itself' },
                { q: '‚à´ 1/x dx', a: 'ln|x| + C', wrong: ['x + C', '-1/x¬≤ + C', 'log(x) + C'], explain: 'This is the natural log integral' },
                { q: '‚à´ x¬≥ dx', a: 'x‚Å¥/4 + C', wrong: ['x‚Å¥ + C', '3x¬≤ + C', '4x¬≥ + C'], explain: 'Power rule for integrals' },
                { q: '‚à´ 3x¬≤ dx', a: 'x¬≥ + C', wrong: ['x¬≥/3 + C', '6x + C', '3x¬≥ + C'], explain: '3¬∑(x¬≥/3) = x¬≥' },
                { q: '‚à´ sec¬≤(x) dx', a: 'tan(x) + C', wrong: ['sec(x) + C', 'cot(x) + C', '2sec(x)tan(x) + C'], explain: 'Reverse of d/dx[tan(x)]' },
            ],
            limits: [
                { q: 'lim(x‚Üí2) [x¬≤]', a: '4', wrong: ['2', '0', '‚àû'], explain: 'Direct substitution: 2¬≤ = 4' },
                { q: 'lim(x‚Üí0) [sin(x)/x]', a: '1', wrong: ['0', '‚àû', 'undefined'], explain: 'Famous limit! Approaches 1' },
                { q: 'lim(x‚Üí‚àû) [1/x]', a: '0', wrong: ['1', '‚àû', 'undefined'], explain: 'As x gets large, 1/x approaches 0' },
                { q: 'lim(x‚Üí0) [(eÀ£-1)/x]', a: '1', wrong: ['0', 'e', '‚àû'], explain: 'Another famous limit = 1' },
                { q: 'lim(x‚Üí3) [x + 5]', a: '8', wrong: ['5', '3', '15'], explain: 'Direct substitution: 3 + 5 = 8' },
                { q: 'lim(x‚Üí‚àû) [x¬≤/x¬≥]', a: '0', wrong: ['1', '‚àû', 'x'], explain: 'x¬≤/x¬≥ = 1/x ‚Üí 0 as x‚Üí‚àû' },
                { q: 'lim(x‚Üí0) [cos(x)]', a: '1', wrong: ['0', '-1', 'undefined'], explain: 'cos(0) = 1' },
                { q: 'lim(x‚Üí1) [(x¬≤-1)/(x-1)]', a: '2', wrong: ['0', '1', 'undefined'], explain: 'Factor: (x+1)(x-1)/(x-1) = x+1 ‚Üí 2' },
                { q: 'lim(x‚Üí‚àû) [5]', a: '5', wrong: ['0', '‚àû', 'undefined'], explain: 'Constant limits equal the constant' },
                { q: 'lim(x‚Üí0‚Å∫) [ln(x)]', a: '-‚àû', wrong: ['0', '1', '‚àû'], explain: 'ln(x) approaches -‚àû as x‚Üí0‚Å∫' },
            ]
        };
        
        function shuffle(arr) {
            const a = [...arr];
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }
        
        function generateProblem() {
            answered = false;
            problemNum++;
            
            document.getElementById('progressFill').style.width = ((problemNum - 1) / totalProblems * 100) + '%';
            
            let pool;
            if (topic === 'mixed') {
                const allTopics = ['derivatives', 'integrals', 'limits'];
                const randomTopic = allTopics[Math.floor(Math.random() * allTopics.length)];
                pool = PROBLEMS[randomTopic];
            } else {
                pool = PROBLEMS[topic];
            }
            
            currentProblem = pool[Math.floor(Math.random() * pool.length)];
            
            // Set problem type label
            if (currentProblem.q.includes('d/dx')) {
                document.getElementById('problemType').textContent = 'DERIVATIVE';
            } else if (currentProblem.q.includes('‚à´')) {
                document.getElementById('problemType').textContent = 'INTEGRAL';
            } else {
                document.getElementById('problemType').textContent = 'LIMIT';
            }
            
            document.getElementById('equation').innerHTML = currentProblem.q;
            document.getElementById('feedback').textContent = '';
            document.getElementById('feedback').className = 'feedback';
            document.getElementById('explanation').classList.remove('visible');
            document.getElementById('explainBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'none';
            
            // Create shuffled choices
            const choices = shuffle([currentProblem.a, ...currentProblem.wrong.slice(0, 3)]);
            const choicesDiv = document.getElementById('choices');
            choicesDiv.innerHTML = '';
            
            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.innerHTML = choice;
                btn.onclick = () => checkAnswer(choice, btn);
                choicesDiv.appendChild(btn);
            });
        }
        
        function checkAnswer(choice, btn) {
            if (answered) return;
            answered = true;
            
            const buttons = document.querySelectorAll('.choice-btn');
            buttons.forEach(b => b.disabled = true);
            
            if (choice === currentProblem.a) {
                btn.classList.add('correct');
                score += 100 + (streak * 20);
                correct++;
                streak++;
                maxStreak = Math.max(maxStreak, streak);
                
                document.getElementById('feedback').textContent = `‚úì Correct! +${100 + (streak - 1) * 20} points`;
                document.getElementById('feedback').className = 'feedback correct';
                GameUtils.playSound('point');
            } else {
                btn.classList.add('wrong');
                // Highlight correct answer
                buttons.forEach(b => {
                    if (b.innerHTML === currentProblem.a) b.classList.add('correct');
                });
                
                streak = 0;
                document.getElementById('feedback').textContent = `‚úó The answer was: ${currentProblem.a}`;
                document.getElementById('feedback').className = 'feedback wrong';
                GameUtils.playSound('gameover');
            }
            
            document.getElementById('explanation').textContent = 'üìö ' + currentProblem.explain;
            document.getElementById('explainBtn').style.display = 'inline-flex';
            document.getElementById('nextBtn').style.display = 'inline-flex';
            
            updateUI();
            
            // Check if game over
            if (problemNum >= totalProblems) {
                document.getElementById('nextBtn').textContent = 'See Results ‚Üí';
                document.getElementById('nextBtn').onclick = endGame;
            }
        }
        
        function showExplanation() {
            document.getElementById('explanation').classList.toggle('visible');
        }
        
        function nextProblem() {
            if (problemNum >= totalProblems) {
                endGame();
            } else {
                generateProblem();
            }
        }
        
        function endGame() {
            GameUtils.showGameOver(score, GAME_ID, {
                extraData: { correct, total: totalProblems, maxStreak, topic }
            });
        }
        
        function updateUI() {
            document.getElementById('score').textContent = score;
            document.getElementById('correct').textContent = correct;
            document.getElementById('streak').textContent = streak;
            document.getElementById('best').textContent = GameUtils.getPersonalBest(GAME_ID);
        }
        
        // Topic selector
        document.querySelectorAll('.topic-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.topic-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                topic = btn.dataset.topic;
                // Reset game
                score = 0;
                correct = 0;
                streak = 0;
                problemNum = 0;
                updateUI();
                generateProblem();
            });
        });
        
        document.getElementById('explainBtn').addEventListener('click', showExplanation);
        document.getElementById('nextBtn').addEventListener('click', nextProblem);
        
        // Initialize
        document.getElementById('best').textContent = GameUtils.getPersonalBest(GAME_ID);
        GameUtils.renderLeaderboard(GAME_ID, 'leaderboard');
        generateProblem();
    </script>
</body>
</html>
