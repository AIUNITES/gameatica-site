<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Snake - Gameatica</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/games.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üêç</text></svg>">
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <a href="../index.html" class="back-btn">‚Üê Back to Arcade</a>
            <h1>üêç Snake</h1>
        </div>
        
        <div class="score-bar">
            <div class="score-item">
                <div class="label">Score</div>
                <div class="value" id="score">0</div>
            </div>
            <div class="score-item">
                <div class="label">High Score</div>
                <div class="value" id="highScore">0</div>
            </div>
            <div class="score-item">
                <div class="label">Level</div>
                <div class="value" id="level">1</div>
            </div>
        </div>

        <div class="game-board">
            <canvas id="gameCanvas" class="game-canvas" width="400" height="400"></canvas>
        </div>

        <div class="game-controls">
            <button class="btn btn-primary" id="startBtn">‚ñ∂ Start Game</button>
            <button class="btn btn-secondary" id="pauseBtn" disabled>‚è∏ Pause</button>
        </div>

        <div class="mobile-controls">
            <div class="dpad">
                <button class="mobile-btn" data-dir="up">‚Üë</button>
                <button class="mobile-btn" data-dir="left">‚Üê</button>
                <button class="mobile-btn" data-dir="right">‚Üí</button>
                <button class="mobile-btn" data-dir="down">‚Üì</button>
            </div>
        </div>

        <div class="leaderboard">
            <h3>üèÜ High Scores</h3>
            <div id="leaderboard"></div>
        </div>

        <div class="instructions">
            <h3>How to Play</h3>
            <ul>
                <li>Use arrow keys or WASD to move the snake</li>
                <li>Eat the red food to grow and score points</li>
                <li>Don't hit the walls or yourself!</li>
                <li>Speed increases as you level up</li>
            </ul>
        </div>
    </div>

    <script src="../js/cloud-database.js"></script>
    <script src="../js/game-utils.js"></script>
    <script>
        const GAME_ID = 'snake';
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const GRID_SIZE = 20;
        const CELL_SIZE = canvas.width / GRID_SIZE;
        
        let snake = [];
        let food = {};
        let direction = 'right';
        let nextDirection = 'right';
        let score = 0;
        let level = 1;
        let gameLoop = null;
        let isPaused = false;
        let isRunning = false;
        
        // Colors
        const COLORS = {
            bg: '#12121a',
            grid: '#1a1a24',
            snake: '#22c55e',
            snakeHead: '#4ade80',
            food: '#ef4444',
            foodGlow: 'rgba(239, 68, 68, 0.3)'
        };
        
        function init() {
            snake = [
                { x: 5, y: 10 },
                { x: 4, y: 10 },
                { x: 3, y: 10 }
            ];
            direction = 'right';
            nextDirection = 'right';
            score = 0;
            level = 1;
            spawnFood();
            updateUI();
            draw();
            
            document.getElementById('highScore').textContent = GameUtils.getPersonalBest(GAME_ID);
            GameUtils.renderLeaderboard(GAME_ID, 'leaderboard');
        }
        
        function spawnFood() {
            do {
                food = {
                    x: Math.floor(Math.random() * GRID_SIZE),
                    y: Math.floor(Math.random() * GRID_SIZE)
                };
            } while (snake.some(s => s.x === food.x && s.y === food.y));
        }
        
        function draw() {
            // Background
            ctx.fillStyle = COLORS.bg;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Grid
            ctx.strokeStyle = COLORS.grid;
            ctx.lineWidth = 1;
            for (let i = 0; i <= GRID_SIZE; i++) {
                ctx.beginPath();
                ctx.moveTo(i * CELL_SIZE, 0);
                ctx.lineTo(i * CELL_SIZE, canvas.height);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(0, i * CELL_SIZE);
                ctx.lineTo(canvas.width, i * CELL_SIZE);
                ctx.stroke();
            }
            
            // Food with glow
            ctx.shadowColor = COLORS.food;
            ctx.shadowBlur = 15;
            ctx.fillStyle = COLORS.food;
            ctx.beginPath();
            ctx.arc(
                food.x * CELL_SIZE + CELL_SIZE / 2,
                food.y * CELL_SIZE + CELL_SIZE / 2,
                CELL_SIZE / 2 - 2,
                0, Math.PI * 2
            );
            ctx.fill();
            ctx.shadowBlur = 0;
            
            // Snake
            snake.forEach((segment, i) => {
                ctx.fillStyle = i === 0 ? COLORS.snakeHead : COLORS.snake;
                ctx.beginPath();
                ctx.roundRect(
                    segment.x * CELL_SIZE + 2,
                    segment.y * CELL_SIZE + 2,
                    CELL_SIZE - 4,
                    CELL_SIZE - 4,
                    4
                );
                ctx.fill();
            });
        }
        
        function update() {
            direction = nextDirection;
            
            const head = { ...snake[0] };
            
            switch (direction) {
                case 'up': head.y--; break;
                case 'down': head.y++; break;
                case 'left': head.x--; break;
                case 'right': head.x++; break;
            }
            
            // Check wall collision
            if (head.x < 0 || head.x >= GRID_SIZE || head.y < 0 || head.y >= GRID_SIZE) {
                gameOver();
                return;
            }
            
            // Check self collision
            if (snake.some(s => s.x === head.x && s.y === head.y)) {
                gameOver();
                return;
            }
            
            snake.unshift(head);
            
            // Check food
            if (head.x === food.x && head.y === food.y) {
                score += 10 * level;
                GameUtils.playSound('point');
                GameUtils.vibrate(30);
                
                if (score % 100 === 0) {
                    level++;
                    GameUtils.playSound('levelup');
                }
                
                spawnFood();
                updateUI();
            } else {
                snake.pop();
            }
            
            draw();
        }
        
        function gameOver() {
            isRunning = false;
            clearInterval(gameLoop);
            GameUtils.playSound('gameover');
            GameUtils.vibrate([100, 50, 100]);
            GameUtils.showGameOver(score, GAME_ID, {
                extraData: { level: level, length: snake.length }
            });
        }
        
        function updateUI() {
            document.getElementById('score').textContent = score;
            document.getElementById('level').textContent = level;
        }
        
        function startGame() {
            if (isRunning) return;
            init();
            isRunning = true;
            isPaused = false;
            
            const speed = Math.max(50, 150 - (level - 1) * 10);
            gameLoop = setInterval(update, speed);
            
            document.getElementById('startBtn').textContent = 'üîÑ Restart';
            document.getElementById('pauseBtn').disabled = false;
        }
        
        function togglePause() {
            if (!isRunning) return;
            
            if (isPaused) {
                const speed = Math.max(50, 150 - (level - 1) * 10);
                gameLoop = setInterval(update, speed);
                document.getElementById('pauseBtn').textContent = '‚è∏ Pause';
            } else {
                clearInterval(gameLoop);
                document.getElementById('pauseBtn').textContent = '‚ñ∂ Resume';
            }
            isPaused = !isPaused;
        }
        
        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'w', 'a', 's', 'd'].includes(e.key)) {
                e.preventDefault();
            }
            
            switch (e.key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    if (direction !== 'down') nextDirection = 'up';
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    if (direction !== 'up') nextDirection = 'down';
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    if (direction !== 'right') nextDirection = 'left';
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    if (direction !== 'left') nextDirection = 'right';
                    break;
                case ' ':
                    e.preventDefault();
                    if (!isRunning) startGame();
                    else togglePause();
                    break;
            }
        });
        
        // Mobile controls
        document.querySelectorAll('.mobile-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const dir = btn.dataset.dir;
                if (dir === 'up' && direction !== 'down') nextDirection = 'up';
                if (dir === 'down' && direction !== 'up') nextDirection = 'down';
                if (dir === 'left' && direction !== 'right') nextDirection = 'left';
                if (dir === 'right' && direction !== 'left') nextDirection = 'right';
                GameUtils.vibrate(20);
            });
        });
        
        // Swipe controls
        GameUtils.enableSwipeControls(canvas, {
            up: () => { if (direction !== 'down') nextDirection = 'up'; },
            down: () => { if (direction !== 'up') nextDirection = 'down'; },
            left: () => { if (direction !== 'right') nextDirection = 'left'; },
            right: () => { if (direction !== 'left') nextDirection = 'right'; }
        });
        
        // Button handlers
        document.getElementById('startBtn').addEventListener('click', startGame);
        document.getElementById('pauseBtn').addEventListener('click', togglePause);
        
        // Initialize
        init();
    </script>
</body>
</html>
